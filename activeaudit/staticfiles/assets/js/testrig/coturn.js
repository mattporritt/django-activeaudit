// @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
"use strict";const allServersKey="servers";let begin,pc,candidates;const servers=document.getElementById("testservers"),serverurl=document.getElementById("serverurl"),usernameInput=document.getElementById("username"),passwordInput=document.getElementById("password"),addBtn=document.getElementById("btn-add-server"),removeBtn=document.getElementById("btn-remove-server"),iceCandidatePool=document.getElementById("poolval"),gatherBtn=document.getElementById("btn-add-candidates"),tableBody=document.getElementById("tbl-body-candidates"),writeServersToLocalStorage=()=>{const e=document.getElementById("testservers"),t=JSON.stringify(Object.values(e.options).map((e=>JSON.parse(e.value))));window.localStorage.setItem("servers",t)},readServersFromLocalStorage=()=>{document.querySelectorAll("#testservers option").forEach((e=>e.remove()));const e=document.getElementById("testservers"),t=window.localStorage.getItem("servers");null!==t&&""!==t&&JSON.parse(t).forEach(((t,n)=>{const r=document.createElement("option");r.value=JSON.stringify(t),r.text=t.urls[0],r.ondblclick=selectServerAcn,e.add(r)}))},formatPriority=e=>[e>>24,e>>8&65535,255&e].join(" | "),appendCell=(e,t,n)=>{const r=document.createElement("td");r.textContent=t,n&&r.setAttribute("colspan",n),e.appendChild(r)},gotDescription=e=>{begin=window.performance.now(),candidates=[],pc.setLocalDescription(e)},noDescription=e=>{console.log("Error creating offer: ",e)},getFinalResult=()=>{let e="Done";if(1===servers.length){const t=JSON.parse(servers[0].value),n=candidates.map((function(e){return e.type}));0===t.urls[0].indexOf("turn:")&&-1===t.urls[0].indexOf("?transport=tcp")&&-1===n.indexOf("relay")&&(e=n.indexOf("srflx")>-1?"Authentication failed?":"Not reachable?")}return e},gatheringStateChange=()=>{if("complete"!==pc.iceGatheringState)return;const e=((window.performance.now()-begin)/1e3).toFixed(3),t=document.createElement("tr");appendCell(t,e),appendCell(t,getFinalResult(),7),pc.close(),pc=null,gatherBtn.disabled=!1,tableBody.appendChild(t)},iceCandidateError=e=>{document.getElementById("error-note").style.display="block",document.getElementById("error").innerText+="The server "+e.url+" returned an error with code="+e.errorCode+":\n"+e.errorText+"\n"},iceCallback=e=>{const t=((window.performance.now()-begin)/1e3).toFixed(3),n=document.createElement("tr");if(appendCell(n,t),e.candidate){if(""===e.candidate.candidate)return;const{candidate:t}=e;console.log(e),console.log(t.component),appendCell(n,t.component),appendCell(n,t.type),appendCell(n,t.foundation),appendCell(n,t.protocol),appendCell(n,t.address),appendCell(n,t.port),appendCell(n,[(r=t.priority)>>24,r>>8&65535,255&r].join(" | ")),candidates.push(t)}else"onicegatheringstatechange"in RTCPeerConnection.prototype||(appendCell(n,getFinalResult(),7),pc.close(),pc=null,gatherBtn.disabled=!1);var r;tableBody.appendChild(n)},selectServerAcn=e=>{const t=e.target,n=JSON.parse(t.value);serverurl.value=n.urls[0],usernameInput.value=n.username||"",passwordInput.value=n.credential||""},addServerAcn=()=>{const e=serverurl.value.split(":")[0];if("stun"!==e&&"turn"!==e&&"turns"!==e)return void alert(`URI scheme ${e} is not valid`);const t=document.createElement("option"),n={urls:[serverurl.value],username:usernameInput.value,credential:passwordInput.value};t.value=JSON.stringify(n),t.text=`${serverurl.value} `;const r=usernameInput.value,o=passwordInput.value;(r||o)&&(t.text+=` [${r}:${o}]`),t.ondblclick=selectServerAcn,servers.add(t),serverurl.value=usernameInput.value=passwordInput.value="",writeServersToLocalStorage()},removeServerAcn=()=>{for(let e=servers.options.length-1;e>=0;--e)servers.options[e].selected&&servers.remove(e);writeServersToLocalStorage()},startAcn=()=>{for(;tableBody.firstChild;)tableBody.removeChild(tableBody.firstChild);gatherBtn.disabled=!0;const e=[];for(let t=0;t<servers.length;++t)e.push(JSON.parse(servers[t].value));const t=document.getElementsByName("transports");let n;for(let e=0;e<t.length;++e)if(t[e].checked){n=t[e].value;break}const r={iceServers:e,iceTransportPolicy:n,iceCandidatePoolSize:iceCandidatePool.value};console.log(`Creating new PeerConnection with config=${JSON.stringify(r)}`),document.getElementById("error").innerText="",pc=new RTCPeerConnection(r),pc.onicecandidate=iceCallback,pc.onicegatheringstatechange=gatheringStateChange,pc.onicecandidateerror=iceCandidateError,pc.createOffer({offerToReceiveAudio:1}).then(gotDescription,noDescription)},addEventListeners=()=>{addBtn.onclick=addServerAcn,removeBtn.onclick=removeServerAcn,gatherBtn.onclick=startAcn};export const init=()=>{window.console.log("Coturn testrig JS."),addBtn.onclick=addServerAcn,removeBtn.onclick=removeServerAcn,gatherBtn.onclick=startAcn,readServersFromLocalStorage(),document.getElementById("getUserMediaPermissions").style.display="none",navigator.mediaDevices.enumerateDevices().then((function(e){e.forEach((function(e){""!==e.label&&(document.getElementById("getUserMediaPermissions").style.display="block"),console.log(e.kind+": "+e.label+" id = "+e.deviceId)}))})).catch((function(e){console.log(e.name+": "+e.message)}))};